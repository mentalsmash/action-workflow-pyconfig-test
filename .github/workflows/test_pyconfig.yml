name: Test pyconfig

on:
  workflow_dispatch:
    inputs:
      string:
        type: string
        default: a string
      boolean:
        type: boolean
        default: true
      int:
        type: number
        default: 42

env:
  CLONE_DIR: src/repo

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.CLONE_DIR }}
          submodules: true

      - name: Test Action
        uses: mentalsmash/actions/pyconfig/configuration@master
        with:
          clone-dir: src/repo
          workflow: test_action
          inputs: ${{ toJson(inputs) }}

      - name: Export configuration settings
        id: config
        run: |
          echo ::group::PyConfig
          cat .pyconfig.json
          echo
          echo ::endgroup::
          
          echo ::group::FOO
          jq '.foo' -jr .pyconfig.json
          echo
          echo ::endgroup::

          echo ::group::BAR
          jq '.bar' -jr .pyconfig.json
          echo
          echo ::endgroup::

          echo ::group::CLONE_DIR
          jq '.build.clone_dir' -jr .pyconfig.json
          echo
          echo ::endgroup::

          echo ::group::A_FUNCTION_OUTPUT
          jq '.A_FUNCTION_OUTPUT' -jr .pyconfig.json
          echo
          echo ::endgroup::
          (
            echo FOO=$(jq '.foo' -jr .pyconfig.json)
            echo BAR=$(jq '.bar' -jr .pyconfig.json)
            echo CLONE_DIR=$(jq '.build.clone_dir' -jr .pyconfig.json)
            echo A_FUNCTION_OUTPUT=$(jq '.A_FUNCTION_OUTPUT' -jr .pyconfig.json)
          ) >> ${GITHUB_OUTPUT}
    
      - name: "Fail if CLONE_DIR wasn't set"
        if: ${{ steps.config.outputs.CLONE_DIR != 'src/repo' }}
        run: |
          exit 1
      - name: "Fail if FOO wasn't set"
        if: ${{ steps.config.outputs.FOO != 'foo' }}
        run: |
          exit 1
      - name: "Fail if BAR wasn't set"
        if: ${{ steps.config.outputs.BAR != 'foo.bar' }}
        run: |
          exit 1
      - name: "Fail if A_FUNCTION_OUTPUT wasn't set"
        if: ${{ steps.config.outputs.A_FUNCTION_OUTPUT != 'foo.bar.a_function' }}
        run: |
          exit 1

      - name: Test Action
        uses: mentalsmash/actions/pyconfig/summary@master
        with:
          clone-dir: src/repo
          workflow: test_action
          inputs: ${{ toJson(inputs) }}
